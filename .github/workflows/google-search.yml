name: Google Search Automation

on:
  schedule:
    # 日本時間午前5時 = UTC 20:00 (前日)
    - cron: '0 20 * * *'
  workflow_dispatch: # 手動実行も可能

jobs:
  google-search:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create config.json from secrets
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        CUSTOM_SEARCH_ENGINE_ID: ${{ secrets.CUSTOM_SEARCH_ENGINE_ID }}
        SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
        SHEET_NAME: ${{ secrets.SHEET_NAME }}
        MAX_REQUESTS: ${{ secrets.MAX_REQUESTS }}
      run: |
        python -c "
        import json
        import os
        max_requests = os.environ.get('MAX_REQUESTS', '100')
        max_requests = int(max_requests) if max_requests and max_requests.strip() else 100
        config = {
            'google_api_key': os.environ.get('GOOGLE_API_KEY'),
            'custom_search_engine_id': os.environ.get('CUSTOM_SEARCH_ENGINE_ID'),
            'spreadsheet_id': os.environ.get('SPREADSHEET_ID'),
            'sheet_name': os.environ.get('SHEET_NAME', 'Sheet1'),
            'max_requests': max_requests,
            'data_dir': 'data',
            'google_sheets_credentials_file': 'credentials.json'
        }
        with open('config.json', 'w') as f:
            json.dump(config, f, indent=2)
        "

    - name: Create Google Sheets credentials file
      run: |
        echo '${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}' > credentials.json

    - name: Run Google Search
      run: |
        python google_search.py

    - name: Upload results as artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: search-results-${{ github.run_number }}
        path: |
          data/
          *.log
        retention-days: 30